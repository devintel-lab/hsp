<!DOCTYPE html>
<html>

<head>
    <title>Verb guessing game</title>
    <script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.1.0/jspsych.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.3.1/plugins/jspsych-free-sort.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.3.1/plugins/jspsych-video-button-response.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.3.1/plugins/jspsych-survey-html-form.js"></script>   
    <link href="https://cdn.jsdelivr.net/gh/jspsych/jsPsych@6.1.0/css/jspsych.css" rel="stylesheet" type="text/css">
    <script src="./hsp.js"></script>
    </link>
</head>

<body>
</body>

<script>
    var ID;
    //<div class="slide" id="training"></div>
    // get the client IP address
    var req = new XMLHttpRequest();
    req.overrideMimeType("application/json");
    req.open('GET', 'https://jsonip.com', false);
    req.onload = function () {
        var jsonResponse = JSON.parse(req.responseText);
        ID = jsonResponse["ip"].replace(new RegExp(':', 'g'), "-")
    };
    req.send(null);

    console.log(ID)
    fetch("data/condition1.json") // json file should have {"videos":.mp4 files, "block_location":1,0,1,1,etc}
        .then(res => res.json())
        .then(data => {
            var stimuli_set = data["videos"] // gather videos into stimuli set
            var training_vids = []
            var experiment_vids = []
            var block_location = data["block_location"] // get block location

            // separate training videos from experimental videos
            for (var i = 0; i < stimuli_set.length; i++) {
                // if video name contains "sample", add to training videos set; else add to experiment videos set
                if (stimuli_set[i].search("sample") != -1)
                    training_vids.push(stimuli_set[i])
                else
                    experiment_vids.push(stimuli_set[i])
            }

            var timeline = []

            /////////////////////////////////
            // Opening information slides //
            ///////////////////////////////

            timeline.push(welcome)
            timeline.push(instructions)


            /////////////////////////
            // Touch screen games //
            ///////////////////////

            // drag images into the circle/area
            var sorting_stimuli = []
            for (var i = 0; i < 3; i++) {
                sorting_stimuli.push("images/sun.jpg")
                sorting_stimuli.push("images/moon.jpg")
            }

            var sorting_game = {
                type: 'free-sort',
                stimuli: sorting_stimuli,
                border_width: 10,
                prompt: '<p>Can you put <b>suns on the left side</b> and <b>moons on the right side?</b></p>',
                counter_text_unfinished: 'You still need to place %n% thing%s% inside the circle.',
                counter_text_finished: '<b>Good job! You did it!</b>'
            }
            timeline.push(sorting_game)

            var drag_image_game = {
                type: 'free-sort',
                stimuli: ["images/fish.jpg"],
                sort_area_shape: "square",
                stim_height: 90,
                stim_width: 100,
                sort_area_height: 500,
                sort_area_width: 500,
                prompt: '<p>Can you drag the <b>fish</b> to the <b>upper right corner</b>?</p>',
                counter_text_unfinished: '',
                counter_text_finished: '<b>Good job! You did it!</b>'
            }
            timeline.push(drag_image_game)


            ///////////////////////////////
            // Randomized order trials //
            /////////////////////////////
        
            // Randomized blocks & fixed attention-getting trials ---------------//
            var randomized_videos = shuffle(experiment_vids)
            const block_size = 2
            for (var i = 0; i < block_size * 3; i++) {

                // attention-getting slide between blocks
                if (i % block_size == 0 && i > 0) {

                    // find the different image
                    var spot_different_image_game = {
                        type: 'html-button-response',
                        stimulus: 'Choose the one that is different',
                        choices: ['-', '-', 'x', '-'],
                        button_html: [
                            '<img src="images/smiley.jpg" width="110" height="110" border="0" alt="javascript button">',
                            '<img src="images/smiley.jpg" width="110" height="110" border="0" alt="javascript button">',
                            '<img src="images/frowny.jpg" width="110" height="110" border="0" alt="javascript button">',
                            '<img src="images/smiley.jpg" width="110" height="110" border="0" alt="javascript button">'],
                        //trial_duration: 60000,    // default: null, set number to specify time limit
                        on_finish: function (data) {
                            if (data.response == 2)
                                data.answer = 'correct'
                            else if (data.response == null)
                                data.answer = 'no answer'
                            else
                                data.answer = 'incorrect'
                        }
                    }
                    timeline.push(spot_different_image_game)
                }

                var random_trial = {
                    type: 'video-button-response',
                    stimulus: [randomized_videos[i]],
                    choices: ['smile', 'frown'],
                    button_html: [
                        '<img src="images/smiley.jpg" width="110" height="110" border="0" alt="javascript button">',
                        '<img src="images/frowny.jpg" width="110" height="110" border="0" alt="javascript button">'],
                    width: 550,
                    //controls: true,
                    trial_duration: 60000,
                    //response_allowed_while_playing: false,
                    on_finish: function (data) {
                        if (data.response == 0)
                            data.answer = 'smile' 
                        else if (data.response == 1)
                            data.answer = 'frown'
                        else
                            data.answer = 'no answer'
                    }
                }
                timeline.push(random_trial)
            }


            ////////////////////////////
            // Demographic questions //
            //////////////////////////

            timeline.push(ask_name)
            timeline.push(ask_age)
            timeline.push(ask_date)
            timeline.push(ask_ID)

            timeline.push(end_slide)

            jsPsych.data.addProperties({ subject: ID });

            jsPsych.init({
                timeline: timeline,
                // preload_video: stimuli_set,
                show_preload_progress_bar: false,
                on_finish: function () { saveData(ID + "_experiment_data", jsPsych.data.get().csv()); },
                on_trial_start: function (data) {
                    console.log("trial started")
                }
            })
        })


</script>

</html>